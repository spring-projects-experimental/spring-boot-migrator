---
anchors:
  git-repo-resource-source: &git-repo-resource-source
    uri: ((github-repo-uri)) # https://github.com/spring-projects-experimental/spring-boot-migrator
    username: ((github-repo-user)) # fabapp2
    password: none # ((github-ci-release-token))
    branch: ci
#  docker-hub-mirror-vars: &docker-hub-mirror-vars
#    docker-hub-mirror: ((docker-hub-mirror))
#    docker-hub-mirror-username: ((docker-hub-mirror-username))
#    docker-hub-mirror-password: ((docker-hub-mirror-password))
  registry-image-resource-source: &registry-image-resource-source
    username: ((docker-hub-username))
    password: ((docker-hub-password))
    tag: ((milestone))
#    registry_mirror:
#      host: ((docker-hub-mirror))
#      username: ((docker-hub-mirror-username))
#      password: ((docker-hub-mirror-password))

resources:
  - name: git-repo
    type: git
    icon: github
    source:
      <<: *git-repo-resource-source
  - name: ci-image
    type: registry-image
    icon: docker
    source:
      <<: *registry-image-resource-source
      repository: fkrueger096/spring-boot-migrator-ci
      tag: latest
  - name: ubuntu
    type: registry-image
    icon: docker
    source:
      repository: library/ubuntu
      username: ((docker-hub-mirror-username))
      password: ((docker-hub-mirror-password))
      tag: focal-20220801
#  - name: ubuntu-manifests
#    type: registry-image
#    icon: docker
#    source:
#      repository: library/ubuntu/manifests
#      username: ((docker-hub-mirror-username))
#      password: ((docker-hub-mirror-password))


#  - name: spring-boot-migrator-image
#    type: docker-image
#    source:
#      repository: othmankh/sbm
#      tag: 1.0.0

jobs:

  - name: build-ci-images
    plan:
    - get: git-repo
    - get: ubuntu
      trigger: true
      params: { format: oci }
#    - task: generate-docker-creds
#      config:
#        platform: linux
#        image_resource:
#          type: registry-image
#          source:
#            repository: alpine
#        outputs:
#          - name: docker_creds
#        run:
#          path: ash
#          args:
#            - -c
#            - |
#              AUTH="$(echo -n '((docker_username)):((docker_password))' | base64)"
#              cat > docker_creds/config.json <<EOF
#              { "auths": { "https://index.docker.io/v1/": { "auth": "$AUTH", "email": "<yourdockeremail>" }}}
#              EOF

#    - task: generate-docker-creds
#      config:
#        platform: linux
#        image_resource:
#          type: registry-image
#          source:
#            repository: library/ubuntu/manifests
#        outputs:
#          - name: docker_manifest_creds
#        run:
#          path: sh
#          args:
#            - -c
#            - |
#              AUTH="$(echo -n '((docker-hub-username)):((docker-hub-password))' | base64)"
#              cat > docker_creds/config.json <<EOF
#              { "auths": { "https://index.docker.io/v1/": { "auth": "$AUTH", "email": "fkrueger@vmware.com" }}}
#              EOF

#  - task: generate-docker-creds-manifest
#      config:
#        platform: linux
#        image_resource:
#          type: registry-image
#          source:
#            repository: library/ubuntu
#        outputs:
#          - name: docker_creds
#        run:
#          path: sh
#          args:
#            - -c
#            - |
#              AUTH="$(echo -n '((docker-hub-username)):((docker-hub-password))' | base64)"
#              cat > docker_creds/config.json <<EOF
#              { "auths": { "https://index.docker.io/v1/": { "auth": "$AUTH", "email": "fkrueger@vmware.com" }}}
#              EOF

    - task: build-ci-image
      privileged: true
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: vito/oci-build-task
        inputs:
          - name: git-repo
#          - name: ubuntu
#          - name: docker_creds
#          - name: docker_manifest_creds
        outputs:
          - name: image
        run:
          path: build
        params:
          LOGIN: PASS
          PASS: ((docker-hub-username)):((docker-hub-password))
          CONTEXT: git-repo/ci/images/ci-image
    - put: ci-image
      params:
        image: image/image.tar
#        DOCKER_CONFIG: docker_creds
#      - in_parallel:
##          - get: ci-image
#          - get: git-repo
#            trigger: true
#      - in_parallel:
#          - task: build-ci-image
#            privileged: true
#            file: git-repo/ci/tasks/build-ci-image.yml
#            output_mapping:
#              image: ci-image
#            vars:
#              ci-image-name: ci-image
#              <<: *docker-hub-mirror-vars
#      - in_parallel:
#          - put: ci-image
#            params:
#              image: ci-image/image.tar

#  - name: spring-boot-migrator-build
#    serial: true
#    plan:
#      - in_parallel:
#          - get: ci-image
#          - get: git-repo
#            trigger: true
#      - in_parallel:
#          - task: build
#            privileged: true
#            image: ci-image
#            file: git-repo/ci/tasks/maven-build/task.yml