- name: boot-2.7-3.0-dependency-version-update
  description: Bump spring-boot-starter-parent from 2.7.x to 3.0.0-M3
  condition:
    type: org.springframework.sbm.boot.common.conditions.HasSpringBootStarterParent
    versionPattern: "2\\.7\\..*"

  actions:

      # TODO: upgrades for 2.7
    - type: org.springframework.sbm.build.migration.actions.AddRepositoryAction
      description: Add Spring Boot milestone repository.
      id: "spring-milestone"
      url: "https://repo.spring.io/milestone"
      snapshotsEnabled: false
      condition:
        type: org.springframework.sbm.build.migration.conditions.NoRepositoryExistsCondition
        id: "spring-milestone"
        url: "https://repo.spring.io/milestone"

    - type: org.springframework.sbm.engine.recipe.OpenRewriteDeclarativeRecipeAdapter
      condition:
        type: org.springframework.sbm.boot.upgrade.common.conditions.HasSpringBootParentOfVersion
        versionStartingWith: "2.7."
      description: Add Spring Milestone Repository and bump parent pom to 3.0.0-M3
      openRewriteRecipe: |-
        type: specs.openrewrite.org/v1beta/recipe
        name: org.openrewrite.java.spring.boot3.data.TEST
        displayName: Upgrade to Spring Data 3.0
        description: 'Upgrade to Spring Data to 3.0 from any prior version.'
        recipeList:
          - org.openrewrite.maven.UpgradeParentVersion:
              groupId: org.springframework.boot
              artifactId: spring-boot-starter-parent
              newVersion: 3.0.0-M3
    - type: org.springframework.sbm.engine.recipe.OpenRewriteDeclarativeRecipeAdapter
      condition:
        type: org.springframework.sbm.boot.upgrade.common.conditions.HasSpringBootParentOfVersion
        versionStartingWith: "2.7."
      description: Move micrometer packages
      openRewriteRecipe: |-
        type: specs.openrewrite.org/v1beta/recipe
        name: org.openrewrite.java.spring.boot3.Micrometer_3_0
        displayName: Micrometer compatible with Boot 3.x
        description: Switch to Micrometer compatible with Boot 3.x
        recipeList:
          - org.openrewrite.java.ChangePackage:
              oldPackageName: io.micrometer.core.instrument.binder
              newPackageName: io.micrometer.binder
              recursive: true
    - type: org.springframework.sbm.engine.recipe.OpenRewriteDeclarativeRecipeAdapter
      condition:
        type: org.springframework.sbm.boot.upgrade.common.conditions.HasSpringBootParentOfVersion
        versionStartingWith: "2.7."
      description: Migrate properties found in `application.properties` and `application.yml` which are not generated automatically from Spring Boot's `additional-spring-configuration-metadata.json` file.
      openRewriteRecipe: |-
        type: specs.openrewrite.org/v1beta/recipe
        name: org.openrewrite.java.spring.boot2.SpringBootPropertiesManual_2_7
        displayName: Migrate additional Spring Boot properties to 2.7
        description: Migrate properties found in `application.properties` and `application.yml` which are not generated automatically from Spring Boot's `additional-spring-configuration-metadata.json` file.
        recipeList:
          # Change: spring.security.saml2.relyingparty.registration.{id}.identityprovider To: spring.security.saml2.relyingparty.registration.{id}.assertingparty
          - org.openrewrite.java.spring.boot2.SamlRelyingPartyPropertyApplicationPropertiesMove # Property files.
          - org.openrewrite.yaml.ChangeKey: # Yaml files
              oldKeyPath: $.spring.security.saml2.relyingparty.registration.*[?(@.identityprovider)]
              newKey: assertingparty
#    - type: org.springframework.sbm.boot.upgrade.common.actions.ReplaceJavaxWithJakartaAction
#      javaxPackagePatterns:
#        - javax.persistence
#        - javax.naming
#        - javax.validation
#        - javax.servlet
#      description: Replace relevant 'javax' packages with their new 'jakarta' replacement
#      condition:
#        type: org.springframework.sbm.java.migration.conditions.HasAnyImportStartingWith
#        importPatterns:
#          - javax.persistence
#          - javax.naming
#          - javax.validation
#          - javax.servlet

#    - type: org.springframework.sbm.build.migration.actions.SetProperty
#      propertyName: "java.version"
#      propertyValue: "17"
#      description: Set Java version to 17
#      condition:
#        type: org.springframework.sbm.common.migration.conditions.TrueCondition
